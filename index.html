<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>RiverLog</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- Favicons -->
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAAAIAAQAwAAFgAAAIlQTkcNChoKAAAADUlIRFIAAAAQAAAAEAgGAAAAH/P/YQAAAtdJREFUeJx1k89rU1kUx7/n3Lz8aPJi0pRU0JZodbTSKs6giGKLRYojWkZRF4MbEdeOC1v9AwTTlS7cisy4EHFRV4ILoWCx6iClUxVHnemkWKz6mqSp76V5794zC2NtRb+7y733e8895/uheConWC4BwUCg8HmHABA0BFxfLSr09WUBiAJRxKipSKTMTKwX/BU6CEJQ/OmBJSZfDAhGtLAKqdloZ27I3vPjnwstjf+9cYte9F9ndWqs0PNx/J8+HehGUmTq1YDqXxAxQuGG6Mvkb4fzO88cf/JzeHVhv59cQwF6Zzl48Wvk2UQxf7PLuXTrbM2tricmAUChetlQIVVMn/5l8MjAqfuDT+NvkEu2lYFeERPNmlDHg4+bvL0Dx+4wCb3N37iojUkRIIinc0HcbpVsV8+1Q/JiizwrZ0pSSs9VpV1EVn6YD06Wq7LhvSvnpFBqPCR/bcl29VyL260ST+cChkCx4lqse/PocWQctCdFzSvLjmAGQFmxSlsRuEp0BdkVmaPIvY11bx1lxTUIFEMEZFklu61lpheZGirgRCJhAFgAQhAEVEWESSVgUO1GQts/tMyQZZUg9U5+R1KPgOYoIgyMIoZ5BShALx5iEEF8P1V5PdV8F04YNkylUqG6gWFCgwC+HcMjADwCx6r8PdUsvp8CERgEbbQJe8PjO67DyeD5HBWNCSoLaCp7OECEx9qFO4e5BkxBrsPJeMPjO4w2YRA0Q8CiWLyJyb6xi1e39a91mlrfBdquomYMNtoxugfgp6STXHew5WliPP/7dm9isk8UCwQcAkAEiA50unh5qP8WsUydOfFkV7haOFZdVZh15fx71lY++Wp67MIfe+evDPXrQKc/B4kWYVoS5VjHmtsNuzc/pLbs9L7WjvbhkRF3+s5Ip7ycPur7QfpbUV4OkzZgxTUOW2XX87wwcTMJRQwTiJbD9LXBp/EtwZmIIJDv4vw/UENWhkHLuskAAAAASUVORK5CYII=" sizes="any" />
  <link rel="icon" type="image/svg+xml" href="assets/icon-crest.svg" />

  <!-- iOS Home Screen Icon -->
  <link rel="apple-touch-icon" href="data:image/png;base64,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" />

  <!-- Styles -->
  <link rel="stylesheet" href="app.css?v=57" />
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">
        <img src="assets/icon-crest.svg" alt="RiverLog" />
      </div>

      <div>
        <div class="title">RiverLog</div>
        <div class="subtitle">Quick catch log (offline-first)</div>
      </div>
    </div>

    <div class="actions">
      <button id="installBtn" class="btn ghost" hidden>Install</button>
      <button id="exportBtn" class="btn" type="button">Export</button>
      <label class="btn ghost fileBtn">
        Import
        <input id="importInput" type="file" accept="application/zip,application/json,.zip,.json" hidden />
      </label>
    </div>
  </header>

  <main class="wrap">
    <!-- TRIP (open) -->
    <section class="card">
      <div class="row">
        <div class="grow">
          <label class="label">Trip</label>
          <div class="row gap">
            <select id="tripSelect" class="input"></select>
            <button id="newTripBtn" class="btn ghost" type="button">New</button>
            <button id="editTripBtn" class="btn ghost" type="button">Edit</button>
            <button id="deleteTripBtn" class="btn ghost danger" type="button">Delete</button>
          </div>
          <div class="hint">Tip: make a new trip at the river. Later you’ll add recap + “Fly that won the day” on your Mac.</div>
        </div>

        <div class="stat">
          <div class="statNum" id="catchCount">0</div>
          <div class="statLbl">Catches</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid2">
        <div>
          <label class="label">Species</label>
          <select id="species" class="input">
            <option value="">—</option>

            <!-- Core Trout -->
            <option>Rainbow Trout</option>
            <option>Brown Trout</option>
            <option>Brook Trout</option>
            <option>Lake Trout</option>
            <option>Cutthroat Trout</option>
            <option>Golden Trout</option>

            <!-- Cutthroat Subspecies -->
            <option>Coastal Cutthroat Trout</option>
            <option>Westslope Cutthroat Trout</option>
            <option>Yellowstone Cutthroat Trout</option>
            <option>Lahontan Cutthroat Trout</option>
            <option>Bonneville Cutthroat Trout</option>
            <option>Greenback Cutthroat Trout</option>
            <option>Rio Grande Cutthroat Trout</option>
            <option>Bear River Cutthroat Trout</option>
            <option>Colorado River Cutthroat Trout</option>
            <option>Snake River Fine-spotted Cutthroat Trout</option>

            <!-- Char (often grouped as trout by anglers) -->
            <option>Brook Trout (Char)</option>
            <option>Bull Trout</option>
            <option>Dolly Varden</option>
            <option>Arctic Char</option>

            <!-- Salmon / Sea-Run Trout -->
            <option>Steelhead</option>
            <option>Atlantic Salmon</option>

            <!-- Hybrids -->
            <option>Tiger Trout</option>
            <option>Splake</option>
            <option>Cutbow Trout</option>

            <!-- Bass / Other (keep existing structure intact) -->
            <option>Smallmouth Bass</option>
            <option>Largemouth Bass</option>
            <option>Salmon (Pacific)</option>
            <option>Other</option>
          </select>
        </div>

        <div>
          <label class="label">Fly</label>
          <input id="fly" class="input" placeholder="e.g., Elk Hair Caddis" />
        </div>

        <div>
          <label class="label">Length (optional)</label>
          <input id="length" class="input" inputmode="decimal" placeholder="inches" />
        </div>

        <div>
          <label class="label">Notes (optional)</label>
          <input id="notes" class="input" placeholder="quick detail" />
        </div>
      </div>

      <div class="row gap topGap">
        <label class="btn fileBtn">
          Capture Photo
          <!-- ONE button: OS chooser includes Camera + Library -->
          <input id="photoInput" type="file" accept="image/*" multiple hidden />
        </label>
        <button id="gpsBtn" class="btn ghost" type="button">Add GPS (optional)</button>
        <button id="saveCatchBtn" class="btn accent" type="button">Save Catch</button>
      </div>

      <div class="hint" id="gpsHint">GPS: not added</div>
      <div class="hint" id="photoHint">Photo: none</div>
    </section>

    <!-- CATCHES (collapsed by default) -->
    <section class="card">
      <details class="collapse" id="catchesCollapse">
        <summary class="collapseSummary">
          Catches
          <span class="muted" id="catchesSummaryMeta"></span>
        </summary>

        <div class="divider"></div>

        <div id="catchList" class="list"></div>
        <div id="emptyState" class="empty">
          No catches yet. Log your first one above.
        </div>
      </details>
    </section>

    <!-- QUIVER (FlyBox, collapsed by default) -->
    <section class="card">
      <details class="collapse" id="flyBoxCollapse">
        <summary class="collapseSummary">
          Quiver
          <span class="muted" id="flyBoxSummaryMeta" style="margin-left:8px;"></span>
        </summary>

        <div class="divider"></div>

        <div class="row">
          <div class="grow">
            <div class="row gap">
              <select id="flyBoxSelect" class="input"></select>
              <button id="newFlyBoxBtn" class="btn ghost" type="button">New</button>
              <button id="editFlyBoxBtn" class="btn ghost" type="button">Edit</button>
              <button id="deleteFlyBoxBtn" class="btn ghost danger" type="button">Delete</button>
            </div>
          </div>

          <div class="stat">
            <div class="statNum" id="flyCount">0</div>
            <div class="statLbl">Flies</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row between center topGap metapad">
          <div class="subtitle2" id="flyBoxMeta">—</div>
          <button id="openFlyModalBtn" class="btn accent" type="button">Add Fly</button>
        </div>

        <div id="flyList" class="list"></div>
        <div id="flyEmpty" class="empty">
          No flies yet. Tap “Add Fly” to add your first pattern.
        </div>
      </details>
    </section>

    <!-- BADGES + INSIGHTS (collapsed by default) -->
    <section class="card">
      <details class="collapse" id="badgesCollapse">
        <summary class="collapseSummary">
          Badges + Insights <span class="muted" style="margin-left:8px;">(milestones + quick stats)</span>
        </summary>

        <div class="divider"></div>

        <!-- 3-up tiles (placeholders for now) -->
        <div class="grid3" id="insightTiles">
          <div class="insightTile">
            <div class="label">Personal Record</div>
            <div class="insightPhoto" id="prTile">
              <div class="insightPhotoPlaceholder">No record yet</div>
            </div>
            <div class="muted" id="prSub">—</div>
          </div>

          <div class="insightTile">
            <div class="label">Best Used Fly</div>
            <div class="insightBig" id="topFlyTile">—</div>
            <div class="muted" id="topFlySub">—</div>
          </div>

          <div class="insightTile">
            <div class="label">Top Species</div>
            <div class="insightBig" id="topSpeciesTile">—</div>
            <div class="muted" id="topSpeciesSub">—</div>
          </div>
        </div>

        <div class="divider"></div>

        <div id="badgeGrid" class="badgeGrid"></div>
      </details>
    </section>

    <!-- TRIP RECAP (collapsed by default) -->
    <section class="card">
      <details class="collapse" id="tripRecapCollapse">
        <summary class="collapseSummary">
          Trip Recap <span class="muted" style="margin-left:8px;">(notes + winner fly)</span>
        </summary>

        <div class="divider"></div>

        <div class="row gap topGap">
          <button id="collageBtn" class="btn" type="button">Build Collage</button>
          <button id="collageBtnTop9" class="btn ghost" type="button">Build Top 9 Collage</button>
        </div>
        <div class="hint">Build a post-trip collage from your catch photos (sorted by length), or preview the top 9.</div>

        <div class="divider"></div>

        <div class="grid2">
          <div>
            <label class="label">Trip Name</label>
            <input id="tripName" class="input" placeholder="e.g., Upper Delaware – Jan 15" />
          </div>
          <div>
            <label class="label">Trip Date</label>
            <input id="tripDate" class="input" type="date" />
          </div>
          <div>
            <label class="label">Location (optional)</label>
            <input id="tripLocation" class="input" placeholder="river / section" />
          </div>
          <div>
            <label class="label">Trip note (optional)</label>
            <input id="tripDesc" class="input" placeholder="who/what/conditions" />
          </div>
          <div>
            <label class="label">Fly that won the day</label>
            <input id="tripFlyWin" class="input" placeholder="one fly to rule them all" />
          </div>
          <div>
            <label class="label">Lessons learned</label>
            <input id="tripLessons" class="input" placeholder="short" />
          </div>
        </div>

        <label class="label topGap">Recap</label>
        <textarea id="tripRecap" class="input area" placeholder="what happened, what you loved, what you’d do again"></textarea>

        <div class="row gap topGap">
          <button id="saveTripBtn" class="btn accent" type="button">Save Recap</button>
        </div>
      </details>
    </section>
  </main>

  <footer class="foot">
    <div class="muted">Offline-first. Data stays on device until you export.</div>
    <div class="muted" id="syncStatus">—</div>
  </footer>

  <!-- New Trip Overlay -->
  <div id="tripSheetOverlay" class="tripSheetOverlay" hidden aria-hidden="true">
    <div id="newTripForm" class="newTrip" hidden role="dialog" aria-modal="true" aria-label="Create new trip">
      <div class="grid2">
        <div class="span2">
          <label class="label">Trip Name</label>
          <input id="newTripName" class="input" placeholder="e.g., A Lifetime" />
        </div>
        <div>
          <label class="label">Where</label>
          <input id="newTripLocation" class="input" placeholder="e.g., West Branch Delaware" />
        </div>
        <div>
          <label class="label">Date</label>
          <input id="newTripDate" class="input" type="date" />
        </div>
        <div class="span2">
          <label class="label">Trip note (optional)</label>
          <input id="newTripDesc" class="input" placeholder="e.g., with Ryan • cold morning • high water" />
        </div>
      </div>

      <div class="row gap topGap">
        <button id="createTripBtn" class="btn accent" type="button">Save new trip</button>
        <button id="cancelTripBtn" class="btn ghost" type="button">Cancel</button>
      </div>

      <div class="hint">Create it fast now; edit anytime later.</div>
    </div>
  </div>

  <!-- Badge Toast -->
  <div id="badgeToast" class="toast hidden" role="status" aria-live="polite" aria-atomic="true">
    <div class="toastInner">
      <div class="toastText">
        <div class="toastTitle" id="badgeToastTitle"></div>
        <div class="toastSub" id="badgeToastSub"></div>
      </div>
      <button id="badgeToastClose" class="toastClose" aria-label="Close badge notification" type="button">✕</button>
    </div>
  </div>

  <!-- Collage Modal -->
  <div id="collageOverlay" class="overlay hidden"></div>
  <div id="collageModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modalHead">
      <div>
        <div class="modalTitle">Trip Collage</div>
        <div class="modalSub" id="collageMeta">Top catches by length</div>
      </div>
      <button id="collageClose" class="btnGhost" type="button">Close</button>
    </div>

    <div class="modalBody">
      <div class="collageWrap">
        <img id="collagePreview" alt="Trip collage preview" />
      </div>
    </div>

    <div class="modalFoot">
      <button id="collageShare" class="btn ghost" type="button">Share</button>
      <button id="collageDownload" class="btn" type="button">Download PNG</button>
    </div>
  </div>

  <canvas id="collageCanvas" width="1400" height="1400" style="display:none;"></canvas>

  <!-- =========================
      Fly Modal (Add/Edit)
      (Moved ABOVE scripts so DOM refs exist when modules load)
  ========================= -->
  <div id="flyModalOverlay" class="overlay hidden" aria-hidden="true"></div>

  <section id="flyModal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true">
    <header class="modalHead">
      <div>
        <div id="flyModalTitle" class="modalTitle">Add Fly</div>
        <div id="flyModalSub" class="modalSub">Quick entry</div>
      </div>
      <button id="flyModalClose" class="btn ghost" type="button" aria-label="Close">✕</button>
    </header>

    <div class="modalBody">
      <div class="grid2">
        <div>
          <label class="label">Type</label>
          <select id="flyType" class="input">
            <option value="">—</option>
            <option value="nymph">Nymph</option>
            <option value="dry">Dry</option>
            <option value="wet">Wet</option>
            <option value="streamer">Streamer</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div>
          <label class="label">Pattern</label>
          <input id="flyPattern" class="input" placeholder="e.g., Zebra Midge" />
        </div>

        <div>
          <label class="label">Size</label>
          <input id="flySize" class="input" inputmode="numeric" placeholder="e.g., 16" />
        </div>

        <div>
          <label class="label">Qty</label>
          <input id="flyQty" class="input" inputmode="numeric" placeholder="e.g., 12" />
        </div>

        <div class="span2">
          <label class="label">Colors (optional)</label>
          <input id="flyColors" class="input" placeholder="black/silver, olive, tan..." />
        </div>

        <div class="span2">
          <label class="label">Photo (one per pattern)</label>
          <input id="flyPhoto" class="input" type="file" accept="image/*" />
          <div id="flyPhotoPreview" class="photoPreview hidden"></div>
        </div>
      </div>
    </div>

    <footer class="modalFoot">
      <button id="flyModalCancel" class="btn ghost" type="button">Cancel</button>
      <button id="addFlyBtn" class="btn accent" type="button">Save Fly</button>
    </footer>
  </section>

  <!-- Scripts -->
  <script src="vendor/jszip.min.js"></script>
  <script type="module" src="js/main.js?v=57"></script>
</body>
</html>
