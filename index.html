<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>RiverLog</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- Favicons -->
  <link rel="icon" type="image/png" href="assets/favicon.png" sizes="any" />

  <!-- iOS Home Screen Icon -->
  <link rel="apple-touch-icon" href="assets/new-logo.png" />

  <!-- Styles -->
  <link rel="stylesheet" href="app.css?v=58" />
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">
        <img src="assets/new-logo.png" alt="RiverLog" />
      </div>

      <div>
        <div class="title">RiverLog</div>
        <div class="subtitle">Quick catch log (offline-first)</div>
      </div>
    </div>

    <div class="actions">
      <button id="installBtn" class="btn ghost" hidden>Install</button>
      <button id="exportBtn" class="btn" type="button">Export</button>
      <label class="btn ghost fileBtn">
        Import
        <input id="importInput" type="file" accept="application/zip,application/json,.zip,.json" hidden />
      </label>
    </div>
  </header>

  <main class="wrap">
    <!-- TRIP (open) -->
    <section class="card">
      <div class="row">
        <div class="grow">
          <label class="label">Trip</label>
          <div class="row gap">
            <select id="tripSelect" class="input"></select>
            <button id="newTripBtn" class="btn ghost" type="button">New</button>
            <button id="editTripBtn" class="btn ghost" type="button">Edit</button>
            <button id="deleteTripBtn" class="btn ghost danger" type="button">Delete</button>
          </div>
          <div class="hint">Tip: make a new trip at the river. Later you’ll add recap + “Fly that won the day” on your Mac.</div>
        </div>

        <div class="stat">
          <div class="statNum" id="catchCount">0</div>
          <div class="statLbl">Catches</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid2">
        <div>
          <label class="label">Species</label>
          <select id="species" class="input">
            <option value="">—</option>

            <!-- Core Trout -->
            <option>Rainbow Trout</option>
            <option>Brown Trout</option>
            <option>Brook Trout</option>
            <option>Lake Trout</option>
            <option>Cutthroat Trout</option>
            <option>Golden Trout</option>

            <!-- Cutthroat Subspecies -->
            <option>Coastal Cutthroat Trout</option>
            <option>Westslope Cutthroat Trout</option>
            <option>Yellowstone Cutthroat Trout</option>
            <option>Lahontan Cutthroat Trout</option>
            <option>Bonneville Cutthroat Trout</option>
            <option>Greenback Cutthroat Trout</option>
            <option>Rio Grande Cutthroat Trout</option>
            <option>Bear River Cutthroat Trout</option>
            <option>Colorado River Cutthroat Trout</option>
            <option>Snake River Fine-spotted Cutthroat Trout</option>

            <!-- Char (often grouped as trout by anglers) -->
            <option>Brook Trout (Char)</option>
            <option>Bull Trout</option>
            <option>Dolly Varden</option>
            <option>Arctic Char</option>

            <!-- Salmon / Sea-Run Trout -->
            <option>Steelhead</option>
            <option>Atlantic Salmon</option>

            <!-- Hybrids -->
            <option>Tiger Trout</option>
            <option>Splake</option>
            <option>Cutbow Trout</option>

            <!-- Bass / Other (keep existing structure intact) -->
            <option>Smallmouth Bass</option>
            <option>Largemouth Bass</option>
            <option>Salmon (Pacific)</option>
            <option>Other</option>
          </select>
        </div>

        <div>
          <label class="label">Fly</label>
          <input id="fly" class="input" placeholder="e.g., Elk Hair Caddis" />
        </div>

        <div>
          <label class="label">Length (optional)</label>
          <input id="length" class="input" inputmode="decimal" placeholder="inches" />
        </div>

        <div>
          <label class="label">Notes (optional)</label>
          <input id="notes" class="input" placeholder="quick detail" />
        </div>
      </div>

      <div class="row gap topGap catchActions">
        <label class="btn fileBtn">
          Capture Photo
          <!-- ONE button: OS chooser includes Camera + Library -->
          <input id="photoInput" type="file" accept="image/*" multiple hidden />
        </label>
        <button id="gpsBtn" class="btn ghost" type="button">Add GPS</button>
        <button id="saveCatchBtn" class="btn accent" type="button">Save Catch</button>
      </div>

      <div class="hint" id="gpsHint">GPS: not added</div>
      <div class="hint" id="photoHint">Photo: none</div>
    </section>

    <!-- CATCHES (collapsed by default) -->
    <section class="card">
      <details class="collapse" id="catchesCollapse">
        <summary class="collapseSummary">
          Catches
          <span class="muted" id="catchesSummaryMeta"></span>
        </summary>

        <div class="divider"></div>

        <div id="catchList" class="list"></div>
        <div id="emptyState" class="empty">
          No catches yet. Log your first one above.
        </div>
      </details>
    </section>

    <!-- QUIVER (FlyBox, collapsed by default) -->
    <section class="card">
      <details class="collapse" id="flyBoxCollapse">
        <summary class="collapseSummary">
          Quiver
          <span class="muted" id="flyBoxSummaryMeta" style="margin-left:8px;"></span>
        </summary>

        <div class="divider"></div>

        <div class="row">
          <div class="grow">
            <div class="row gap">
              <select id="flyBoxSelect" class="input"></select>
              <button id="newFlyBoxBtn" class="btn ghost" type="button">New</button>
              <button id="editFlyBoxBtn" class="btn ghost" type="button">Edit</button>
              <button id="deleteFlyBoxBtn" class="btn ghost danger" type="button">Delete</button>
            </div>
          </div>

          <div class="stat">
            <div class="statNum" id="flyCount">0</div>
            <div class="statLbl">Flies</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row between center topGap metapad">
          <div class="subtitle2" id="flyBoxMeta">—</div>
          <button id="openFlyModalBtn" class="btn accent" type="button">Add Fly</button>
        </div>

        <div id="flyList" class="list"></div>
        <div id="flyEmpty" class="empty">
          No flies yet. Tap “Add Fly” to add your first pattern.
        </div>
      </details>
    </section>

    <!-- BADGES + INSIGHTS (collapsed by default) -->
    <section class="card">
      <details class="collapse" id="badgesCollapse">
        <summary class="collapseSummary">
          Badges + Insights <span class="muted" style="margin-left:8px;">(milestones + quick stats)</span>
        </summary>

        <div class="divider"></div>

        <!-- 3-up tiles (placeholders for now) -->
        <div class="grid3" id="insightTiles">
          <div class="insightTile">
            <div class="label">Personal Record</div>
            <div class="insightPhoto" id="prTile">
              <div class="insightPhotoPlaceholder">No record yet</div>
            </div>
            <div class="muted" id="prSub">—</div>
          </div>

          <div class="insightTile">
            <div class="label">Best Used Fly</div>
            <div class="insightBig" id="topFlyTile">—</div>
            <div class="muted" id="topFlySub">—</div>
          </div>

          <div class="insightTile">
            <div class="label">Top Species</div>
            <div class="insightBig" id="topSpeciesTile">—</div>
            <div class="muted" id="topSpeciesSub">—</div>
          </div>
        </div>

        <div class="divider"></div>

        <div id="badgeGrid" class="badgeGrid"></div>
      </details>
    </section>

    <!-- TRIP RECAP (collapsed by default) -->
    <section class="card">
      <details class="collapse" id="tripRecapCollapse">
        <summary class="collapseSummary">
          Trip Recap <span class="muted" style="margin-left:8px;">(notes + winner fly)</span>
        </summary>

        <div class="divider"></div>

        <div class="row gap topGap">
          <button id="collageBtn" class="btn" type="button">Build Collage</button>
          <button id="collageBtnTop9" class="btn ghost" type="button">Build Top 9 Collage</button>
        </div>
        <div class="hint">Build a post-trip collage from your catch photos (sorted by length), or preview the top 9.</div>

        <div class="divider"></div>

        <div class="grid2">
          <div>
            <label class="label">Trip Name</label>
            <input id="tripName" class="input" placeholder="e.g., Upper Delaware – Jan 15" />
          </div>
          <div>
            <label class="label">Trip Date</label>
            <input id="tripDate" class="input" type="date" />
          </div>
          <div>
            <label class="label">Location (optional)</label>
            <input id="tripLocation" class="input" placeholder="river / section" />
          </div>
          <div>
            <label class="label">Trip note (optional)</label>
            <input id="tripDesc" class="input" placeholder="who/what/conditions" />
          </div>
          <div>
            <label class="label">Fly that won the day</label>
            <input id="tripFlyWin" class="input" placeholder="one fly to rule them all" />
          </div>
          <div>
            <label class="label">Lessons learned</label>
            <input id="tripLessons" class="input" placeholder="short" />
          </div>
        </div>

        <label class="label topGap">Recap</label>
        <textarea id="tripRecap" class="input area" placeholder="what happened, what you loved, what you’d do again"></textarea>

        <div class="row gap topGap">
          <button id="saveTripBtn" class="btn accent" type="button">Save Recap</button>
        </div>
      </details>
    </section>
  </main>

  <footer class="foot">
    <div class="muted">Offline-first. Data stays on device until you export.</div>
    <div class="muted" id="syncStatus">—</div>
  </footer>

  <!-- New Trip Overlay -->
  <div id="tripSheetOverlay" class="tripSheetOverlay" hidden aria-hidden="true">
    <div id="newTripForm" class="newTrip" hidden role="dialog" aria-modal="true" aria-label="Create new trip">
      <div class="grid2">
        <div class="span2">
          <label class="label">Trip Name</label>
          <input id="newTripName" class="input" placeholder="e.g., A Lifetime" />
        </div>
        <div>
          <label class="label">Where</label>
          <input id="newTripLocation" class="input" placeholder="e.g., West Branch Delaware" />
        </div>
        <div>
          <label class="label">Date</label>
          <input id="newTripDate" class="input" type="date" />
        </div>
        <div class="span2">
          <label class="label">Trip note (optional)</label>
          <input id="newTripDesc" class="input" placeholder="e.g., with Ryan • cold morning • high water" />
        </div>
      </div>

      <div class="row gap topGap">
        <button id="createTripBtn" class="btn accent" type="button">Save new trip</button>
        <button id="cancelTripBtn" class="btn ghost" type="button">Cancel</button>
      </div>

      <div class="hint">Create it fast now; edit anytime later.</div>
    </div>
  </div>

  <!-- Badge Toast -->
  <div id="badgeToast" class="toast hidden" role="status" aria-live="polite" aria-atomic="true">
    <div class="toastInner">
      <div class="toastText">
        <div class="toastTitle" id="badgeToastTitle"></div>
        <div class="toastSub" id="badgeToastSub"></div>
      </div>
      <button id="badgeToastClose" class="toastClose" aria-label="Close badge notification" type="button">✕</button>
    </div>
  </div>

  <!-- Collage Modal -->
  <div id="collageOverlay" class="overlay hidden"></div>
  <div id="collageModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modalHead">
      <div>
        <div class="modalTitle">Trip Collage</div>
        <div class="modalSub" id="collageMeta">Top catches by length</div>
      </div>
      <button id="collageClose" class="btnGhost" type="button">Close</button>
    </div>

    <div class="modalBody">
      <div class="collageWrap">
        <img id="collagePreview" alt="Trip collage preview" />
      </div>
    </div>

    <div class="modalFoot">
      <button id="collageShare" class="btn ghost" type="button">Share</button>
      <button id="collageDownload" class="btn" type="button">Download PNG</button>
    </div>
  </div>

  <canvas id="collageCanvas" width="1400" height="1400" style="display:none;"></canvas>

  <!-- =========================
      Fly Modal (Add/Edit)
      (Moved ABOVE scripts so DOM refs exist when modules load)
  ========================= -->
  <div id="flyModalOverlay" class="overlay hidden" aria-hidden="true"></div>

  <section id="flyModal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true">
    <header class="modalHead">
      <div>
        <div id="flyModalTitle" class="modalTitle">Add Fly</div>
        <div id="flyModalSub" class="modalSub">Quick entry</div>
      </div>
      <button id="flyModalClose" class="btn ghost" type="button" aria-label="Close">✕</button>
    </header>

    <div class="modalBody">
      <div class="grid2">
        <div>
          <label class="label">Type</label>
          <select id="flyType" class="input">
            <option value="">—</option>
            <option value="nymph">Nymph</option>
            <option value="dry">Dry</option>
            <option value="wet">Wet</option>
            <option value="streamer">Streamer</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div>
          <label class="label">Pattern</label>
          <input id="flyPattern" class="input" placeholder="e.g., Zebra Midge" />
        </div>

        <div>
          <label class="label">Size</label>
          <input id="flySize" class="input" inputmode="numeric" placeholder="e.g., 16" />
        </div>

        <div>
          <label class="label">Qty</label>
          <input id="flyQty" class="input" inputmode="numeric" placeholder="e.g., 12" />
        </div>

        <div class="span2">
          <label class="label">Colors (optional)</label>
          <input id="flyColors" class="input" placeholder="black/silver, olive, tan..." />
        </div>

        <div class="span2">
          <label class="label">Photo (one per pattern)</label>
          <input id="flyPhoto" class="input" type="file" accept="image/*" />
          <div id="flyPhotoPreview" class="photoPreview hidden"></div>
        </div>
      </div>
    </div>

    <footer class="modalFoot">
      <button id="flyModalCancel" class="btn ghost" type="button">Cancel</button>
      <button id="addFlyBtn" class="btn accent" type="button">Save Fly</button>
    </footer>
  </section>

  <!-- Scripts -->
  <script src="vendor/jszip.min.js"></script>
  <script type="module" src="js/main.js?v=57"></script>
</body>
</html>
